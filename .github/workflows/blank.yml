name: Build Kernel

# 触发条件：每次 push 到 master 分支时触发

on:

  push:

    branches:

      - master

jobs:

  build:

    runs-on: ubuntu-latest

    

    steps:

    - name: Checkout source code

      uses: actions/checkout@v2

      

    - name: Install dependencies

      run: |

        sudo apt-get update

        sudo apt-get install -y git bc build-essential libncurses5-dev libssl-dev flex bison

        

    - name: Set up toolchain

      # 下载并设置 toolchain 路径和编译器版本

      run: |

        git clone https://github.com/kdrag0n/proton-clang.git --depth=1

        export PATH="$(pwd)/proton-clang/bin:$PATH"

        

    - name: Compile kernel

      # 进入项目目录，并执行编译命令

      run: |

        cd kernel-source

        make ARCH=arm64 <your_defconfig>

        make -j$(nproc) ARCH=arm64 CC=clang CROSS_COMPILE=aarch64-linux-gnu-

    - name: Create release

      # 将编译好的内核打包成 zip 文件，并发布到 GitHub Release 中

      uses: actions/upload-release-asset@v1

      with:

        asset_path: |

          kernel-source/arch/arm64/boot/Image.gz-dtb

          kernel-source/arch/arm64/boot/dtbo.img

        asset_name: kernel.zip

        upload_url: ${{ env.RELEASE_UPLOAD_URL }}

        github_token: ${{ secrets.GITHUB_TOKEN }}
